<!DOCTYPE html>
<html>
    <head>
        <title>Covid-19 and Communities</title>
        <script src="https://d3js.org/d3.v4.js"></script>
        <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
        integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
        crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
        integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
        crossorigin=""></script>

        <style>
            * {
                font-family: "Trebuchet MS", "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", Tahoma, sans-serif;
                background-color: rgb(51, 51, 51);
                color: rgb(224, 219, 194);
                scroll-behavior: smooth;
            }

            .switch {
                position: relative;
                display: inline-block;
                width: 60px;
                height: 30px;
                right: 30px;
                bottom: 4px;
            }

            .slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgb(70, 70, 70);
                transition: .5s;
            }

            .slider:before {
                position: absolute;
                content: "";
                height: 24px;
                width: 24px;
                left: 3px;
                bottom: 3px;
                background-color: rgb(218, 218, 218);
                transition: .5s;
            }

            input:checked + .slider {
                background-color: rgb(197, 128, 0);
            }

            input:checked + .slider:before {
                transform: translateX(30px);
            }

            .hint {
                position: absolute;
                right: 50px;
                top: 50px;
                height: 50px;
                width: 100px;
            }

            .hintText {
                position: absolute;
                color: rgb(197, 128, 0);
                right: 0;
                bottom: 0;
                font-size: 25px;
            }

            interactText {
                position: relative;
            }

            interactText::before {
                content: "";
                background-color: rgb(197, 128, 0);
                position: absolute;
                bottom: 2px;
                width: 100%;
                height: 25%;
                transition: .4s;
                opacity: 70%;
            }

            interactText:hover::before {
                bottom: 0;
                height: 100%;
            }

            .title {
                height: 60px;
                font-size: 60px;
                text-align: center;
                color: rgb(218, 218, 218);
                padding: 10px 10px;
                margin: 0;
            }

            .areaGraph{
                margin: auto;
                color: rgb(85, 0, 0)
            }

            .axis path{
                stroke: rgb(224, 219, 194);
            }

            .axis line{
                stroke: rgb(224, 219, 194);
            }

            .axis text{
                fill: rgb(224, 219, 194);
                font-size: 10px;
            }

            .map{
                width: 100%;
                height: 500px;
                background-color: rgb(255, 255, 255);
                stroke-width: 1px;
            }

            .choroLegend {
                font-size: 15px;
                stroke: none;
            }

            .lineScatter path {
                stroke: rgb(224, 219, 194);
            }

            .lineScatter line {
                stroke: rgb(224, 219, 194);
            }

            .lineScatter text {
                font-size: 15px;
                fill: rgb(224, 219, 194);
            }

            .boxPlot text {
                font-size: 15px;
                fill: rgb(224, 219, 194);
            }

            .boxPlot path {
                stroke: none;
            }

            .boxPlot line {
                stroke: rgb(224, 219, 194);
            }

            .boxPlotY text {
                font-size: 12px;
                fill: rgb(224, 219, 194);
            }

            .boxPlotY path {
                stroke: rgb(224, 219, 194);
            }

            .boxPlotY line {
                stroke: rgb(224, 219, 194);
            }

            #play-button {
                background: rgb(197, 128, 0);
                padding-right: 26px;
                border-radius: 3px;
                border: none;
                color: white;
                margin: 0;
                padding: 0 12px;
                width: 60px;
                cursor: pointer;
                height: 30px;
            }

            #play-button:hover {
                background-color: rgb(165, 161, 141);
            } 

            p {
                padding: 10px 200px;
                font-size: 20px;
                line-height: 140%;
                margin-top: 0px;
                margin-bottom: 0px;
            }

            .marker {
                position: absolute;
                bottom: 0;
                font-size: 16px;
                color: rgb(197, 128, 0);
                display: block;
            }

        </style>
    </head>

    <body>
        <div id="title" class="title">
            COVID-19 Cases & Communities
        </div>

        <div id="hintSwitch" class="hint">
            <div id="hintText" class="hintText">
                <h4>Hint!</h4>
            </div>
            <label class="switch">
                <input type="checkbox" id="hintOption" checked onclick="hideHints()">
                <span class="slider"></span>
              </label>
        </div>

        <div>
            <p>Covid-19 has been influencing our life a lot. Since New South Wales is the state with the most populated city, 
                it important to find out the communities that are most vulnearable to Covid-19. The diagram below recorded the 
                number of new Covid-19 cases reported everyday in NSW. </p> 
            <p>The pandemic has been spreading so fast in the communities after it's new variants occured that in 
                fact the actual grouth of new case numbers can only be displayed in a 
                <interactText onmouseover="mouseover1('hint1')" onmouseout="mouseout1('hint1')">Log scale</interactText> for you to better view.</p>
            <p>With a peak of 40,756 cases a day at 6th of June, 2022, the virus gets more dangerous with it's new variant. 
                You could put your cursor within the <interactText onmouseover="mouseover2('hint2')" onmouseout="mouseout2('hint2')">area Plot
                </interactText>'s area to view other values.</p>
            <p>With Omicron spreading the fastest as almost in a Log curve, it has significantly affected the communities. Press the play button to view 
                the sum of Covid-19 Cases in each communities from start to a point on the map. You could also use the slider to view different time's values.</p>
            </div>

        <div class="areaGraph">
            <svg id="areaGraph" width="100%" height="200px"></svg>
        </div>

        
        <div style="position: absolute;top:580px; left:20px">
            <button id="play-button">Play</button>
        </div>

        <div id="map" style="width:1550px; height: 650px;">
            <svg width="1550px" height="650px"></svg>
        </div>

        <div style="position: absolute; top:630px; right:10px">
            <svg id="mapLegend" width="120px" height="300px"></svg>
        </div>
        
        <div style="position: absolute;top:1300px; right:10px">
            <label class="switch">
                <input type="checkbox" id="textHide" checked onclick="hideText()">
                <span class="slider"></span>
              </label>
        </div>

        <div style="position: absolute;top:1330px; right:35px">
              <div id="textHideText">
                Hide text
              </div>
        </div>

        <div id="hideText">
            <p>From all dark for hundreds of days to suddenly significant change color to orange, even light yellow, the east coast part of NSW where the city 
                Sydeney sits has been suffering from Covid-19 a lot.</p>
            <p>You could try to hover over a community to view it's important census data and Covid-19 case number's disturibution on the box plot. Hover over 
                a box plot's axis to view stastic details. Click on the hide  text button on the right to hide this part of text to view the box plot and the
                 map at the same time.</p>
            <p>The communities that have the most number of Covid-19 cases is postcode 
                <interactText onmouseover="mouseover3('2170')" onmouseout="mouseout3('2170')">2170</interactText>. With 27545 as the number of Covid-19 cases, 
                it is a huge outlier that even can not be displayed on the box plot. The reason behind that many of Covid-19 cases can be observed on the box plot, 
                as it's population is also a huge outlier. With a very high population and  a relative small area, this communities has a higher than average 
                Covid-19 case by population rate and must be paid attention to if there are more infection waves to come.</p>

            <p>The situation for community that has a postcode of
                <interactText onmouseover="mouseover3('2145')" onmouseout="mouseout3('2145')">2145</interactText> is almost the same as 2170. Both of them 
                are huge outliers in the aspect of Covid-19 cases and population. Noticibaly, they all have lower than average median ages. This might be a 
                cause for the large amount of infection since younger group are more likely to gather together and tends to live in a more populated area.
                Both of them have a high enemploy rate as well.</p>

            
            <p>The unemployment result doesn't seem to be the same for community 
                <interactText onmouseover="mouseover3('2570')" onmouseout="mouseout3('2570')">2570</interactText>. This community has a low unemployment rate 
                but still has a very high Covid-19 case number and Covid-19 case per population. The median age in that area is also low, and population is 
                high.</p>

            <p>Going through most communities with high Covid-19 case numbers, a potential of low median age can be observed. Community 
                <interactText onmouseover="mouseover3('2444')" onmouseout="mouseout3('2444')">2444</interactText> is an exception. It has a higher than average 
                median age but still has a high Covid-19 case number because of the fact it is highly populated. Although it's case numbers are high, it's case per 
                population stats are low.</p>

            <p>Community <interactText onmouseover="mouseover3('2775')" onmouseout="mouseout3('2775')">2775</interactText> is a special one among all the 
                communities with high Covid-19 case numbers surrounding it. The main reason of this might be it's relative low population and relative high 
                median age.</p>

            <br>
        </div>

        <div>
            <svg id="mapValue" width="1200px" height="30px"></svg>
        </div>

        <div style="padding: 100">
            <svg id="boxPlotValue" width="1600px" height="20px"></svg>
            <svg id="boxPlot" width="1600px" height="250px"></svg>
        </div>

        <div style="display: block;">
            <div>
                <svg id="correlogram" width="800px" height="800px"></svg>
            </div>
            <br><br>
            <button id="casesButton">Covid-19 Case</button>
            <button id="perPopButton">Covid-19 Case per Pop.</button>
            <div>
                <svg id="lineGraph" width="500px" height="500px"></svg>
            </div>
        </div>

        <script>
            var isHintOpen = true

            function hideText(){
                isHintOpen = document.getElementById("textHide").checked
                if (isHintOpen){
                    d3.select("#hideText").style("display", "block")
                    d3.selectAll(".leaflet-tooltip").style("display", "block")
                    d3.select("#textHideText").text("Hide text")
                }
                else {
                    d3.select("#hideText").style("display", "none")
                    d3.selectAll(".leaflet-tooltip").style("display", "none")
                    d3.select("#textHideText").text("Show text")
                    window.scrollTo(0, 630);
                }
            }

            function hideHints(){
                isHintOpen = document.getElementById("hintOption").checked
                if (isHintOpen){
                    document.head.appendChild(document.createElement("style")).innerHTML = "interactText::before {opacity: 70%}"
                    d3.selectAll(".leaflet-tooltip").style("display", "block")
                }
                else {
                    document.head.appendChild(document.createElement("style")).innerHTML = "interactText::before {opacity: 0%}"
                    d3.selectAll(".leaflet-tooltip").style("display", "none")
                }
            }

            function mouseover1(id){
                if(isHintOpen){
                    d3.select("#"+id).selectAll('text').style("stroke", "rgb(197, 128, 0)").style("stroke-width", 1)
                }
            }

            function mouseout1(id){
                if(isHintOpen){
                    d3.select("#"+id).selectAll('text').style("stroke", "rgb(224, 219, 194)").style("stroke-width", 0)
                }
            }

            function mouseover2(id){
                if(isHintOpen){
                    d3.select("#"+id).style("opacity", 0.5)
                }
            }

            function mouseout2(id){
                if(isHintOpen){
                    d3.select("#"+id).style("opacity", 1)
                }
            }

            function mouseover3(postcode){
                if(isHintOpen){
                    d3.selectAll(".leaflet-tooltip").style("opacity", 0.2)
                    d3.select(".marker" + postcode).style("opacity", 0.9)

                    d3.select("#boxPlot").selectAll(".POA" + postcode).transition().style("opacity", 1)
                    d3.select("#boxPlotValue").selectAll(".POA" + postcode).transition().style("opacity", 1)
                    d3.select("#mapValue").select("text").text(function(){return "Postcode: " + postcode})
                }
            }

            function mouseout3(postcode){
                if(isHintOpen){
                    d3.selectAll(".leaflet-tooltip").style("opacity", 0.9)
                    
                    d3.select("#boxPlot").selectAll("circle").transition().style("opacity", 0)
                    d3.select("#boxPlotValue").selectAll("text").transition().style("opacity", 0)
                    d3.select("#mapValue").select("text").text("Hover over a location!")
                }
            }

            var markerList = [{text: "2170", lon: -33.93, lat: 150.93}, 
                        {text: "2145", lon: -33.81, lat: 150.95}, 
                        {text: "2570", lon: -34.05, lat: 150.6}, 
                        {text: "2444", lon: -31.39, lat: 152.87},
                        {text: "2775", lon: -33.3, lat: 151}]

            //Area Graph
            d3.csv("https://raw.githubusercontent.com/hsha0039/DVP-data/main/covid_19_case_by_date.csv", 
                function(d){return {date: d3.timeParse("%Y-%m-%d")(d.notification_date), value: d.covid_case}}, 
                function(totalCaseData){
                    
                var margin = {top: 30, right: 50, bottom: 30, left: 100}
                width = 1500 - margin.left - margin.right
                height = 200 - margin.top - margin.bottom

                var svg = d3.select("#areaGraph")
                    .append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                        .attr("class", "area")
                        .attr("transform",
                            "translate(" + margin.left + "," + margin.top + ")");

                var xScale = d3.scaleTime()
                    .domain(d3.extent(totalCaseData, function(d) { return d.date}))
                    .range([ 0, width ]);

                svg.append("g")
                    .attr("class", "axis")
                    .transition()
                    .duration(2000)
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(xScale).ticks(20))
                    


                var yScale = d3.scaleLog()
                    .base(2)
                    .domain([1, d3.max(totalCaseData, function(d) { return +d.value; })])
                    .range([ height - 1, 0 ]);
                    
                svg.append("g")
                    .attr("class", "axis")
                    .attr("id", "hint1")
                    .transition()
                    .duration(2000)
                    .call(d3.axisLeft(yScale).ticks(7))

                svg.append("g")
                    .attr("id", "hint2")
                    .selectAll("bar")
                    .data(totalCaseData)
                    .enter()
                    .append("rect")
                        .attr("x", function(d) { return xScale(d.date); })
                        .transition()
                        .duration(2000)
                        .attr("y", function(d) { return yScale(d.value) + 1; })
                        .attr("width", 2.5)
                        .attr("height", function(d) { return height - yScale(d.value); })
                        .attr("fill", function(d) {
                            if (d.date> new Date('2021-12-03')) {
                                return "rgb(144, 12, 63)"
                            }
                            else if (d.date> new Date('2021-6-18')){
                                return "rgb(199, 0, 57)"
                            }
                            else {
                                return "rgb(255, 87, 51)"
                            }
                        })
                
                svg.append("rect")
                    .attr("x", 10)
                    .attr("y", height - 100)
                    .attr("width", 20)
                    .attr("height", 5)
                    .attr("fill", "rgb(144, 12, 63)")
                
                svg.append("text")
                    .attr("x", 35)
                    .attr("y", height - 92)
                    .text("Omicron")
                        .style("font-size","15px")
                        .style("fill", "rgb(144, 12, 63)")
                
                svg.append("rect")
                    .attr("x", 10)
                    .attr("y", height - 120)
                    .attr("width", 20)
                    .attr("height", 5)
                    .attr("fill", "rgb(199, 0, 57)")

                svg.append("text")
                    .attr("x", 35)
                    .attr("y", height - 112)
                    .text("Delta")
                        .style("font-size","15px")
                        .style("fill", "rgb(199, 0, 57)")

                svg.append("rect")
                    .attr("x", 10)
                    .attr("y", height - 140)
                    .attr("width", 20)
                    .attr("height", 5)
                    .attr("fill", "rgb(255, 87, 51)")

                svg.append("text")
                    .attr("x", 35)
                    .attr("y", height - 132)
                    .text("Original & Other")
                        .style("font-size","15px")
                        .style("fill", "rgb(255, 87, 51)")

                
                var bisect = d3.bisector(function(d) { return d.date; }).left
                var formatTime = d3.timeFormat("%d/%m/%y")       

                svg.append('rect')
                    .style("fill", "none")
                    .style("pointer-events", "all")
                    .attr('width', width)
                    .attr('height', height)
                    .on('mouseover', mouseover)
                    .on('mousemove', mousemove)
                    .on('mouseout', mouseout)

                var focus = svg
                    .append('g')
                    .append('circle')
                        .style("fill", "none")
                        .attr("stroke", "white")
                        .attr('r', 5)
                        .style("opacity", 0)
                
                var focusText = svg
                    .append('g')
                    .append('text')
                        .style("opacity", 0)
                        .attr("text-anchor", "left")
                        .attr("alignment-baseline", "middle")
                        .style("fill", "white")
                

                function mouseover() {
                    focus.style("opacity", 1)
                    focusText.style("opacity",1)
                }

                function mousemove() {
                    var x0 = xScale.invert(d3.mouse(this)[0]);
                    var i = bisect(totalCaseData, x0, 1);
                    selectedData = totalCaseData[i]
                    focus
                        .attr("cx", xScale(selectedData.date))
                        .attr("cy", yScale(selectedData.value))
                    focusText
                        .html(formatTime(selectedData.date) + ": " + selectedData.value + " cases")
                        .attr("x", xScale(selectedData.date) - 100)
                        .attr("y", yScale(selectedData.value) - 20)
                }

                function mouseout() {
                    focus.style("opacity", 0)
                    focusText.style("opacity", 0)
                }
                           
            })

            //Box Plot
            d3.csv("https://raw.githubusercontent.com/hsha0039/DVP-data/main/Covid_cases_census_data.csv", function(data){
                var featureList = ["Population", "Median Age", "Median Income", "Unemp Rate", "Mean Yr of Edu", "Case Per Pop", "Covid Case"]
                var dataSum = []
                featureList.forEach(function(element){
                    q1 = d3.quantile(data.map(function(d) { return parseFloat(d[element]);}).sort(d3.ascending),.25)
                    median = d3.quantile(data.map(function(d) { return parseFloat(d[element]);}).sort(d3.ascending),.5)
                    q3 = d3.quantile(data.map(function(d) { return parseFloat(d[element]);}).sort(d3.ascending),.75)
                    interQuantileRange = q3 - q1
                    min = q1 - 1.5 * interQuantileRange
                    if (min < 0) { min = 0}
                    max = q3 + 1.5 * interQuantileRange
                    dataSum.push({name: element, q1: q1, median: median, q3: q3, interQuantileRange: interQuantileRange, min: min, max: max})
                })

                var margin = {top: 0, right: 30, bottom: 30, left: 40},
                    width = 1600 - margin.left - margin.right,
                    height = 250 - margin.top - margin.bottom;

                var svg = d3.select("#boxPlot")
                    .append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                        .attr("transform",
                            "translate(" + margin.left + "," + margin.top + ")");

                var valueSvg = d3.select("#boxPlotValue")
                    .append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", 20)
                    .append("g")
                        .attr("transform",
                            "translate(" + margin.left + ",0)");

                var color = d3.scaleOrdinal()
                    .domain(featureList)
                    .range(d3.schemeSet2);

                
                var x = d3.scaleBand()
                    .range([0, width])
                    .domain(featureList)
                    .paddingInner(1)
                    .paddingOuter(.5)

                svg.append("g")
                    .attr("class", "boxPlot")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x))

                var yScales = dataSum.map(function(d){
                    return d3.scaleLinear().domain([d.min/1.5, d.max*1.5]).range([height,0])
                })

                dataSum.forEach(function(element, index) {
                    var y = yScales[index]

                    svg.append("text")
                        .attr("class", "stats")
                        .attr("x", function(){return(x(element.name) - 85)})
                        .attr("y", 13)
                        .style("font-size", 13)
                        .style("fill", "rgb(224, 219, 194)")
                        .text(function(){return "75%: " + element.q3.toFixed(2)})
                        .style("opacity", 0)

                    svg.append("text")
                        .attr("class", "stats")
                        .attr("x", function(){return(x(element.name) - 85)})
                        .attr("y", 29)
                        .style("font-size", 13)
                        .style("fill", "rgb(224, 219, 194)")
                        .text(function(){return "50%: " + element.median.toFixed(2)})
                        .style("opacity", 0)
                    
                    svg.append("text")
                        .attr("class", "stats")
                        .attr("x", function(){return(x(element.name) - 85)})
                        .attr("y", 45)
                        .style("font-size", 13)
                        .style("fill", "rgb(224, 219, 194)")
                        .text(function(){return "25%: " + element.q1.toFixed(3)})
                        .style("opacity", 0)

                    svg.append("g")
                        .attr("class", "boxPlotY")
                        .call(d3.axisLeft(y))
                        .attr("transform", "translate("+ (x(element.name) - width*0.06)+ ",0)")
                        .on("mouseover", function(){return d3.selectAll(".stats").transition().style("opacity", 1)} )
                        .on("mouseout", function(){return d3.selectAll(".stats").transition().style("opacity", 0)} )    

                    svg.append("line")
                            .attr("x1", function(){return(x(element.name) + 0.5)})
                            .attr("x2", function(){return(x(element.name)+ 0.5)})
                            .attr("y1", function(){return(y(element.min))})
                            .attr("y2", function(){return(y(element.max))})
                            .attr("stroke", "rgb(224, 219, 194)")       

                    var boxWidth = 80

                    svg.append("rect")
                            .attr("x", function(){return(x(element.name)-boxWidth/2)})
                            .attr("y", function(){return(y(element.q3))})
                            .attr("height", function(){return(y(element.q1)-y(element.q3))})
                            .attr("width", boxWidth )
                            .attr("stroke", "rgb(224, 219, 194)")
                            .style("fill", function(){return color(element.name)})                           

                    svg.append("line")
                        .attr("x1", function(){return(x(element.name)-boxWidth/2) })
                        .attr("x2", function(){return(x(element.name)+boxWidth/2) })
                        .attr("y1", function(){return(y(element.median))})
                        .attr("y2", function(){return(y(element.median))})
                        .attr("stroke", "black")

                    valueSvg.selectAll("valueText")
                        .data(data)
                        .enter()
                        .append("text")
                            .attr("class", function(d){return "POA" + d.Postcode})
                            .attr("x", function(d){return(x(element.name))})
                            .attr("y", 15)
                            .text(function(d){return parseFloat(d[element.name]).toFixed(2)})
                            .style("text-anchor", "middle")
                            .style("opacity", 0)
                            .style("font-size", 20)
                            .style("fill", function(){return color(element.name)})

                    var jitterWidth = 50
                    svg
                        .selectAll("indPoints")
                        .data(data)
                        .enter()
                        .append("circle")
                            .attr("class", function(d){return "POA" + d.Postcode})
                            .attr("cx", function(d){return(x(element.name) - jitterWidth/2 + Math.random()*jitterWidth )})
                            .attr("cy", function(d){return(y(d[element.name]))})
                            .attr("r", 6)
                            .style("fill", "white")
                            .attr("stroke", "gray")
                            .attr("stroke-width", 2)
                    
                    svg.selectAll("circle").style("opacity", 0)
                })

            //Choropleth Map
            d3.json("https://raw.githubusercontent.com/hsha0039/DVP-data/main/POA_2016_NSW.json", function(mapData){
                d3.csv("https://raw.githubusercontent.com/hsha0039/DVP-data/main/confirmed_cases_table1_location_agg.csv", function(caseData) {
                    
                    var parseDate = d3.timeParse("%d/%m/%Y");

                    var moving = false;
                    var currentValue = 0;
                    var targetValue = 1350;

                    var playButton = d3.select("#play-button");

                    var startDate = new Date("2020-01-25"),
                        endDate = new Date("2022-04-04");

                    var curDate = endDate

                    var map = L.map('map').setView([-33, 150], 6.5);

                    function createMarkers(){
                        markerList.forEach(function(element){
                            var marker = new L.marker([element.lon, element.lat], {opacity: 0})
                            marker.bindTooltip(element.text, {permanent: true, className: "marker" + element.text, offset: [-15, 25]})
                            marker.addTo(map)
                        })
                    }
                    createMarkers()

                    var colorScale = d3.scaleSequential()
                            .domain([0, Math.sqrt(27546)])
                            .interpolator(d3.interpolateInferno)

                    legendSvg = d3.select("#mapLegend")

                    legendSvg.append("text")
                                .attr("x", 10)
                                .attr("y", 15)
                                .style("font-size", 15)
                                .style("fill", "rgb(224, 219, 194)")

                                .text("Total Covid-19")
                    legendSvg.append("text")
                                .attr("x", 12)
                                .attr("y", 30)
                                .style("font-size", 15)
                                .style("fill", "rgb(224, 219, 194)")
                                .text("Cases")

                    function plotLegend(legendList)
                    {
                        legendList.forEach(function(element,index) {
                            legendSvg.append("rect")
                                .attr("x", 10)
                                .attr("y", 35 + 25*index)
                                .attr("width", 20)
                                .attr("height", 20)
                                .attr("fill", colorScale(Math.sqrt(element)))
                    
                            legendSvg.append("text")
                                .attr("x", 35)
                                .attr("y", 47 + 25*index)
                                .style("font-size", 20)
                                .style("fill", colorScale(Math.sqrt(element)))
                                .text(element)
                        })
                    }

                    plotLegend([0,1250,2500,5000,10000,20000,27545])
                    

                    function compareColor(color1, color2) {
                        const hexToRgb = hex =>
                            hex.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i
                                        ,(m, r, g, b) => '#' + r + r + g + g + b + b)
                                .substring(1).match(/.{2}/g)
                                .map(x => parseInt(x, 16))
                        const threshold = 200

                        color1 = hexToRgb(color1)
                        color2 = hexToRgb(color2)

                        difference = (color1[0]-color2[0])**2+(color1[1]-color2[1])**2+(color1[2]-color2[2])**2

                        return difference > threshold ? true:false
                    }

                    function getColor(postcode) {
                        var itemList = caseData.filter(function(d){
                            return d.postcode == postcode && parseDate(d.date) <= curDate
                        })
                        if (itemList.length == 0)
                        {
                            return colorScale(0)
                        }
                        else{
                            return colorScale(Math.sqrt(d3.sum(itemList, d => d.value)))
                        }
                    }
                        
                    function style(feature) {
                        return {
                            fillColor: getColor(feature.properties.POA_CODE16),
                            weight: 0.5,
                            color: "rgb(224, 219, 194)",
                            fillOpacity: 1
                        };
                    }      

                    function highlightFeature(e) {
                        var postcode = e.target.feature.properties.POA_CODE16
                        d3.select("#boxPlot").selectAll(".POA" + postcode).transition().style("opacity", 1)
                        d3.select("#boxPlotValue").selectAll(".POA" + postcode).transition().style("opacity", 1)
                        d3.select("#mapValue").select("text").text(function(){return "Postcode: " + postcode})
                        var layer = e.target;

                        layer.setStyle({
                            weight: 5,
                            color: 'rgb(197, 128, 0)',
                            fillOpacity: 0.7
                        });

                        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                            layer.bringToFront();
                        }
                    }

                    function resetHighlight(e) {
                        geojson.resetStyle(e.target);
                        d3.select("#boxPlot").selectAll("circle").transition().style("opacity", 0)
                        d3.select("#boxPlotValue").selectAll("text").transition().style("opacity", 0)
                        d3.select("#mapValue").select("text").text("Hover over a location!")
                    }

                    function onEachFeature(feature, layer) {
                        layer.on({
                            mouseover: highlightFeature,
                            mouseout: resetHighlight
                        });
                    }

                    geojson = L.geoJson(mapData, {
                        style: style,
                        onEachFeature: onEachFeature
                    }).addTo(map);

                    
                    var mapSvg = d3.select("#mapValue")
                        .append("svg")
                            .attr("width", 600)
                            .attr("height", 30)

                    mapSvg.append("text")
                        .attr("class", "hintText")
                        .attr("x", 20)
                        .attr("y", 15)
                        .text("Hover over a location!")
                        .style("font-size", 20)
                        .style("fill", "rgb(224, 219, 194)")
                        

                    var x = d3.scaleTime()
                        .domain([startDate,endDate])
                        .range([0, targetValue])
                        .clamp(true);

                    playButton
                        .on("click", function() {
                            var button = d3.select(this);
                            if (button.text() == "Pause") {
                                moving = false;
                                clearInterval(timer);
                                // timer = 0;
                                button.text("Play");
                            } else {
                                window.scrollTo(0, 325);
                                moving = true;
                                timer = setInterval(step, 200);
                                button.text("Pause");
                            }
                            console.log("Slider moving: " + moving);
                    })

                    function step() {
                        update(x.invert(currentValue))
                        currentValue = currentValue + (targetValue/150);
                        if (currentValue > targetValue) {
                            moving = false;
                            currentValue = 0;
                            clearInterval(timer);
                            playButton.text("Play");
                            console.log("Slider moving: " + moving);
                        }
                    }

                    function update(date) {
                        curDate = date
                        sliderSvg.select(".tracker")
                            .transition()
                            .duration(50)
                            .attr("x1", x(date) + 1)
                            .attr("x2", x(date) + 1)
                        
                        sliderSvg.select(".tracker-ball")
                            .transition()
                            .duration(50)
                            .attr("cx", x(date) + 1)

                        geojson.eachLayer(function(layer) {
                            newColor = getColor(layer.feature.properties.POA_CODE16)
                            if (compareColor(layer.options.fillColor, newColor))
                            {
                                layer.setStyle({
                                fillColor: newColor
                                })
                            }
                        });
                    }

                    var sliderSvg = d3.select("#areaGraph")
                        .select("svg").selectAll(".area")
                    
                    sliderSvg.append("line")
                        .transition()
                        .duration(1000)
                        .attr("class", "tracker")
                        .attr("x1", x(endDate) + 1)
                        .attr("x2", x(endDate) + 1)
                        .attr("y1", 0)
                        .attr("y2", 140)
                        .style("stroke", "rgb(197, 128, 0)")
                        .style("stroke-width", 3)

                    
                    sliderSvg.append("circle")
                        .attr("class", "tracker-ball")
                        .attr("cx", x(endDate) + 1)
                        .attr("cy", 0)
                        .attr("r", 8)
                        .style("fill", "rgb(197, 128, 0)")
                        .style("stroke", "rgb(218, 199, 164)")
                        .style("stroke-width", 2)
                        .call(d3.drag()
                            .on("start.interrupt", function() { sliderSvg.interrupt(); })
                            .on("start drag", function() {
                            currentValue = d3.event.x
                            update(x.invert(currentValue)) 
                        }))
                        .on("mouseover", function(d){
                            d3.select(this).style("cursor", "pointer")
                        })
                        .on("moverleft", function(d){
                            d3.select(this).style("cursor", "default")
                        })
                })
            })

            })


            d3.json("https://raw.githubusercontent.com/hsha0039/DVP-data/main/variant_correlation.json", function(data){
                var selectedValue = "values1"

                d3.select("#casesButton")
                    .on("click", function(){
                        update("values1")
                    })
                    .on("mouseover", function(d){
                            d3.select(this).style("cursor", "pointer")
                        })
                    .on("moverleft", function(d){
                            d3.select(this).style("cursor", "default")
                        })

                d3.select("#perPopButton")
                    .on("click", function(){
                        update("values2")
                    })
                    .on("mouseover", function(d){
                            d3.select(this).style("cursor", "pointer")
                        })
                    .on("moverleft", function(d){
                            d3.select(this).style("cursor", "default")
                        })

                var margin = {top: 30, right: 60, bottom: 30, left: 30},
                    width = 500 - margin.left - margin.right,
                    height = 500 - margin.top - margin.bottom;

                var svg = d3.select("#lineGraph")
                    .append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                        .attr("transform",
                            "translate(" + margin.left + "," + margin.top + ")");
                
                var color = d3.scaleOrdinal()
                    .domain(data.map(d => d.name))
                    .range(d3.schemeSet2);

                var x = d3.scaleBand()
                    .domain(["Original & Other", "Delta", "Omicron"])
                    .range([ 0, width ]);

                svg.append("g")
                    .attr("class", "lineScatter")
                    .attr("transform", "translate(0," + height*0.5 + ")")
                    .call(d3.axisBottom(x));

                // Add Y axis
                var y = d3.scaleLinear()
                    .domain( [-1,1])
                    .range([ height, 0 ]);
                svg.append("g")
                    .attr("class", "lineScatter")
                    .call(d3.axisLeft(y));

                // Add the lines
                var line = d3.line()
                    .x(function(d) { return x(d.variant) + 68 })
                    .y(function(d) { return y(d.value) })

                var myLines = svg.selectAll(".linePlotLines")
                    .data(data).enter()
                    .append("g")
                        .attr("class", "linePlotElements")
                    .append("path")
                        .transition()
                        .duration(1000)
                        .attr("class", function(d){ return d.name })
                        .attr("d", function(d){ return line(d[selectedValue]) } )
                        .attr("stroke", function(d){ return color(d.name) })
                        .attr("stroke-linecap", "round")
                        .style("stroke-width", 4)
                        .style("fill", "none")
                
                var labels = svg.selectAll("myLabels")
                    .data(data)
                    .enter()
                    .append("text")
                        .attr("class", function(d){ return d.name })
                        .attr("x", 380)
                        .attr("y", function(d,i){ return i * 20})
                        .text(function(d) { return d.name; })
                        .style("fill", function(d){ return color(d.name) })
                        .style("font-size", 12)
                

                // Add the points
                var points = svg.selectAll(".dots")
                    .data(data)
                    .enter()
                        .append('g')
                            .style("fill", function(d){ return color(d.name) })
                            .attr("class", function(d){ return d.name })

                points.selectAll("Points")
                    .data(function(d){ return d[selectedValue] }).enter()
                    .append("circle")
                    .on('mouseover', mouseover)
                    .on('mousemove', function(d) {mousemove(d)})
                    .on('mouseout', mouseout)
                        .attr("cx", function(d) { return x(d.variant) + 68 } )
                        .transition()
                        .duration(2000)
                        .attr("cy", function(d) { return y(d.value) } )
                        .attr("r", 7)
                        .attr("stroke-width", "5")


                function update(selectedGroup){
                     
                    var containers = svg.selectAll("g.linePlotElements")
                        .data(data)

                    containers
                        .select("path")
                        .transition()
                        .duration(1000)
                        .attr("d", function(d) {  return line(d[selectedGroup])})  
                    
                    points.selectAll("circle").remove()

                    var newpoints = points.selectAll("Points")
                        .data(function(d){ return d[selectedGroup] }).enter()
                        .append("circle")
                        .on('mouseover', mouseover)
                        .on('mousemove', function(d) {mousemove(d)})
                        .on('mouseout', mouseout)
                            .attr("cx", function(d) { return x(d.variant) + 68 } )
                            .attr("cy", function(d) { return y(d.value) } )
                            .attr("r", 0)
                            .style("opacity", 1)
                            .attr("stroke-width", "5")
                    
                    newpoints.transition()
                        .duration(1200)
                        .attr("r", 7)

                }

                var focusText = svg
                    .append('g')
                    .append('text')
                        .attr("text-anchor", "left")
                        .attr("alignment-baseline", "middle")
                        .style("fill", "white")
                        .text("Hover a point!")
                        .attr("x", 15)
                        .attr("y", 10)

                function mouseover() {                    
                    d3.select(this).transition().attr("stroke", "white")
                    focusText.text("Hover over a point")
                }

                function mousemove(data) {
                    focusText.text("Correlation: " + data.value)
                }

                function mouseout() {
                    d3.select(this).transition().attr("stroke", "none")
                    focusText.text("Hover over a point")
                }
                
                //Correlation Matrix
                d3.csv("https://raw.githubusercontent.com/hsha0039/DVP-data/main/df_correlation.csv", function(data){
                    var margin = {top: 100, right: 100, bottom: 20, left: 20},
                        width = 800 - margin.left - margin.right,
                        height = 800 - margin.top - margin.bottom

                    var corSvg = d3.select("#correlogram")
                        .append("svg")
                            .attr("width", width + margin.left + margin.right)
                            .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                    var domain = d3.set(data.map(function(d) { return d.Var1 })).values()
                    var num = Math.sqrt(data.length)

                    // Create a color scale
                    var color2 = d3.scaleLinear()
                        .domain([-1, 0, 1])
                        .range(["rgb(172, 0, 0)", "rgb(230,230,230)", "rgb(0, 57, 172)"]);


                    // Create a size scale for bubbles on top right. Watch out: must be a rootscale!
                    var size = d3.scaleSqrt()
                        .domain([0, 1])
                        .range([0, 30]);

                    // X scale
                    var xScale = d3.scalePoint()
                        .range([60, width])
                        .domain(domain)

                    // Y scale
                    var yScale = d3.scalePoint()
                        .range([0, height])
                        .domain(domain)

                    // Create one 'g' element for each cell of the correlogram
                    var cor = corSvg.selectAll(".cor")
                        .data(data)
                        .enter()
                        .append("g")
                        .attr("class", "cor")
                        .attr("transform", function(d) {
                            return "translate(" + (xScale(d.Var1) + 15) + "," + yScale(d.Var2) + ")";
                        });

                    cor.filter(function(d){
                        var ypos = domain.indexOf(d.Var2);
                        var xpos = domain.indexOf(d.Var1);
                        return xpos <= ypos;
                        })
                        .append("text")
                            .attr("y", 5)
                            .html(function(d) {
                                if (d.Var1 === d.Var2) {
                                return d.Var1;
                                } else {
                                return d.value;
                                }
                            })
                            .transition()
                            .duration(2000)
                            .style("font-size", function(d){
                                if (d.Var1 === d.Var2) {
                                return 15;
                                } else {
                                return 25;
                                }
                            })
                            .style("text-align", "center")
                            .style("fill", function(d){
                                if (d.Var1 === d.Var2) {
                                return "rgb(210,210,210)";
                                } else {
                                return color2(d.value);
                                }
                            })
                            .attr("transform", function(d) {
                                if (d.Var1 === d.Var2) {
                                return "translate(-35,-2)"
                                } else {
                                return "translate(-30,4)"
                                }
                            });


                    // Up right part: add circles
                    cor.filter(function(d){
                        var ypos = domain.indexOf(d.Var2);
                        var xpos = domain.indexOf(d.Var1);
                        return xpos > ypos;
                        })
                        .append("circle")
                        .on("click", function(d){
                                if(d.Var1 == "Covid cases" && d.Var2 != "Cases per Pop."){
                                    currentOpacity = d3.selectAll("." + d.Var2.split(" ").join(".")).style("opacity")
                                    d3.selectAll("." + d.Var2.split(" ").join(".")).transition().style("opacity", currentOpacity == 1 ? 0:1)
                                }
                            })
                        .on("mouseover", function(d){
                                if(d.Var1 == "Covid cases" && d.Var2 != "Cases per Pop."){
                                    d3.select(this).style("cursor", "pointer")
                                }
                            })
                        .on("moverleft", function(d){
                                if(d.Var1 == "Covid cases" && d.Var2 != "Cases per Pop."){
                                    d3.select(this).style("cursor", "default")
                                }
                            })
                        .transition()
                        .duration(2000)
                            .attr("r", function(d){ return size(Math.abs(d.value)) })
                            .style("fill", function(d){
                                if (d.Var1 === d.Var2) {
                                return "none";
                                } else {
                                return color2(d.value);
                                }
                            })

                    cor.filter(function(d){
                        return d.Var1 == "Covid cases" && (d.Var2 != "Cases per Pop." && d.Var2 != "Covid cases")
                        })
                        .append("circle")
                        .attr("class", "hint")
                        .transition()
                        .duration(2000)
                            .attr("r", function(d){ return size(Math.abs(d.value)) + 10 })
                            .style("fill", "none")
                            .style('stroke', function(d){ return color(d.Var2)})
                            .style('stroke-width', 5)
                    
                    var legendScale = d3.scaleLinear()
                            .range([-margin.top + 90, height + margin.bottom - 20])
                            .domain([1, -1]);
                                
                    var colorAxis = corSvg.append("g")
                        .attr("class", "choroLegend")
                        .call(
                            d3.axisLeft()
                                .scale(legendScale)
                                .tickPadding(7))
                        .attr("transform", "translate(20,0)");

                    var h = height / 100 + 3;
                    d3.range(-1, 1.01, 0.01).forEach(function(d){
                        colorAxis.append('rect')
                            .style('fill',color2(d))
                            .style('stroke-width', 0)
                            .style('stoke', 'none')
                            .attr('height', h)
                            .attr('width', 5)
                            .attr('x', 0)
                            .attr('y', legendScale(d))
                    });
                    
                })

            })

        </script>
    </body>
</html>